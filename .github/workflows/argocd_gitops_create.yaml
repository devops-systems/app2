name: ARGOCD GITOPS CREATE

on:
  create

jobs:
  Test: 
    runs-on: 'ubuntu-latest'
    steps:
      - name: Get envs                 
        run: |
          env
      - name: Checkout ArgoCD GitOps repo
        uses: actions/checkout@master
        with:
          repository: devops-systems/argocd-gitops
      - name: Get folders                 
        run: |
          ls -al
      - name: Generate variables                 
        run: |
          export REPO=$(echo $GITHUB_REPOSITORY | cut -d "/" -f2) >> $GITHUB_ENV
          export BRANCH=$GITHUB_REF_NAME >> $GITHUB_ENV
          export IMAGE_TAG=$GITHUB_SHA >> $GITHUB_ENV
      - name: Generate file 
        run: |
          curl -sfL -o /usr/local/bin/kyml https://github.com/frigus02/kyml/releases/download/v20210610/kyml_20210610_linux_amd64 && chmod +x /usr/local/bin/kyml
          cat templates/argocd_gitops_features.yaml | kyml tmpl -e REPO -e BRANCH -e IMAGE_TAG | tee apps-features/${{ env.REPO }}-${{ env.BRANCH }}.yaml
        env:
          REPO: ${{ env.REPO }}
          BRANCH: ${{ env.BRANCH }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
